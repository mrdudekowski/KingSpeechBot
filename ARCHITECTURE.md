# Архитектура SimplePoll Bot Template

## Принципы
- Модульность: шаги, сервисы, инфраструктура разделены
- Расширяемость: легко добавлять языки, шаги, интеграции
- Локализация: все тексты во внешних JSON
- Конфигурация через переменные окружения (.env)
- Тестируемость: моки для внешних сервисов, unit и e2e сценарии

## Слои
- Interface (Telegram): `main.py` — регистрация хендлеров, маршрутизация сообщений/колбэков
- Domain (Steps): `steps/*` — сценарии, работа с `Context`, возврат `Step`
- Services (Integrations): `services/*` — Sheets, Localization, AI (опционально)
- Infrastructure: `cursor.py` (базовые классы), `config.py` (env конфиг)

## Поток данных
1. Пользователь отправляет сообщение / нажимает кнопку
2. `main.py` определяет текущий шаг из `Context` и вызывает соответствующий обработчик в `steps/*`
3. Шаг формирует `Step(message, options, next_step)` с локализованным текстом
4. При завершении сценария данные через `SheetsService` сохраняются в Google Sheets

## Локализация
- Динамическая загрузка всех `locales/*.json`
- Fallback: `lang` → `ru` → `en` → ключ

## Интеграции
- `GoogleSheets` (в `cursor.py`) — низкоуровневый клиент
- `SheetsService` — высокоуровневые операции и правила (создание листа по месяцу, нормализация к русскому)
- `ai_tutor_service.py` — опционально (может быть отключён)

## Тестирование
- `test_bot.py` — e2e сценарии (ru/en), утилиты (remove_emojis)
- Unit-тесты: локализация (ключи, fallback), Sheets (моки ошибок), AI (таймауты)

## Расширение
- Новый шаг: создайте модуль в `steps/`, подключите из `main.py`
- Новый язык: добавьте файл в `locales/`, ключи должны соответствовать `ru.json`
- Новая интеграция: создайте сервис в `services/`, инкапсулируйте детали

## Best Practices
- Не храните секреты в коде (используйте .env)
- Не смешивайте тексты в коде — только ключи локализации
- Ловите и логируйте ошибки внешних сервисов
- Пишите тесты на ключевые ветви и обработку ошибок
